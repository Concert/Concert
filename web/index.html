<html>
    <head>
        <title>
            Concert
        </title>
        
        <script type="text/javascript" src ="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        
        <script type="text/javascript" src="js/helpers.js"></script>
        <script type="text/javascript" src="js/Waveform.js"></script>
        <script type="text/javascript" src="js/WaveformEditor.js"></script>
        <script type="text/javascript" src="js/WaveformViewer.js"></script>
        <script type="text/javascript" src="js/Highlighter.js"></script>
        <script type="text/javascript">
            var $audios = Array();
            var $waveformPlayers = Array();

            $(document).ready(function(){
                
                /* Disable all click behavior on page */
                $(document).mousedown(function(event){
                    event.preventDefault();
                });
                
                /* Set loading notification */
                $('h1').after('<span id="loading"><img src="images/ajax-loader.gif" /> Loading</span>');
                
                /**
                 *  Wait until all audio elements can be accessed
                 **/
                 /* Compile list of audio element names */
                 $.each($('audio'), function(index, data){
                     var $audioObj = new Object();
                     $audioObj.id = data.id;
                     $audioObj.status = 0;
                     $audios.push($audioObj);
                 });
                 initialize_audio_durations($audios);
                
                 
                /**
                 *  play button behavior.  Plays audio, and adds 'playing class.
                 **/
                $('#play_button').click(function(){
                    play_main();
                });
                $(document).keydown(function(event){
                   if(event.keyCode == 32) 
                   {
                       event.preventDefault();
                       if($('#waveform_viewer').hasClass('playing') || $('#waveform_editor').hasClass('playing'))
                       {
                           pause_audio('example_audio');
                       }
                       else
                       {
                           play_main();
                       }
                   }
                });
                
                /**
                 *  pause button behavior.  Pauses audio, and removes 'playing' class.
                 **/
                $('#pause_button').click(function(){
                    pause_audio('example_audio');
                });
                
                /**
                 *  highlight event handler.
                 **/
                $('#waveform_editor').bind('highlight', function(e, data){
                    alert('highlighted: '+data.start+' to '+data.end);
                });
            });            
            
            function play_main()
            {
                play_audio('example_audio');
                $waveformPlayers['waveform_viewer'].play();
                $waveformPlayers['waveform_editor'].play();
            }
            
            function play_audio($audio_id)
            {
                var $player = $('#'+$audio_id).addClass('playing').get(0);
                $player.play();
                auto_pause_audio($audio_id);
            }
            
            function pause_audio($audio_id)
            {
                var $player = $('#'+$audio_id).removeClass('playing').get(0);
                $player.pause();
            }
                        
            function auto_pause_audio($audio_id)
            {
                /* See if audio is at the end */
                var $player = $('#'+$audio_id).get(0);
                
                /* If player has reached the end */
                if($player.duration == $player.currentTime)
                {
                    /* remove 'playing' class */
                    $('#'+$audio_id).removeClass('playing');
                    /* pause audio */
                    $player.pause();
                }
                /* If player has already been paused */
                else if(!$($player).hasClass('playing'))
                {
                    /* Do nothing */
                    
                }
                else
                {
                    /* If still playing, check again in 100 ms */
                    setTimeout('auto_pause_audio("'+$audio_id+'")', 100);
                }
            }
             /**
              * check_audio_duration
              * Given an id of an audio object, will return true if the duration attribute
              * is accessable.
              *
              * @param          $audio_id           id of the audio object
              **/
             function check_audio_duration($audio_id)
             {
                 if($('#'+$audio_id).attr('duration'))
                 {
                     return true;
                 }
                 else
                 {
                     return false;
                 }
             }
             
             /**
              * initialize_audio_durations
              * Loops through the $audios array, checking to see if the element is accessable.
              * If so, sets the status of the element and moves on.  If all were accessable, or previously
              * marked as such, the initialize_waveform_speeds() is called.  If any were found inaccesable, the function
              * is run again in 100ms.
              *
              * @param          $audios             the array of 'audio' objects which are defined above.
              **/
             function initialize_audio_durations($audios)
             {
                 var $all = 1;
                 $.each($audios, function(index, value){
                     /* if this audio element is not loaded yet */
                     if(!value.status)
                     {
                         var $result = check_audio_duration(value.id);
                         if($result == false)
                         {
                             setTimeout('initialize_audio_durations($audios)', 100);
                             $all = 0;
                         }
                         else
                         {
                             $audios[index].status = 1;
                         }                         
                     }
                 });
                 
                 if($all)
                 {
                     /* If all audio objects were able to be accessed, move on */
                     initialize_waveform_objects();                   
                 }
                 
             }
             
             function remove_loading()
             {
                 $('#loading').remove();
             }
             
             function initialize_waveform_objects()
             {
                 /* For each waveform container, create associated object */
                 $waveformPlayers['waveform_editor'] = new WaveformEditor('waveform_editor', 'example_audio');
                 $waveformPlayers['waveform_viewer'] = new WaveformViewer('waveform_viewer', 'example_audio');
                 
                 
                 
                 
                 /*
                 for(var $i in $waveformPlayers) {
                     $('#test > p').append('<br />'+$waveformPlayers[$i].toString());
                 }
                 */

                 remove_loading();
             }
             
             
            
        </script>
    </head>
    
    <body>
        <div id="waveform_viewer" class="waveform" style="width: 800px; height: 100px; border: 1px #bbb dashed outside;">
        	<div id="viewer_playhead" class="playhead" style = "margin-left:0px;width:1px; background-color: #66FF99; height:inherit; position: absolute;z-index: 1;"></div>
        	<div id="viewer_timecode" class="timecode" style="margin-left: 755px; font-size: .75em; color: white; position: absolute; z-index: 2;">00:00:00</div>
            <img src="media/Oddity_1660.png" class="waveform_image" id="waveform_viewer_image" style="width: 100%; height: 100%;"/>
        </div>
        <br />
        <div id ="waveform_editor" class="waveform" style="width: 800px; height: 585px; border:1px #bbb dashed; overflow: hidden; background-color: black;">
            <div id="highlight" style="background-color: #00FFFF; z-index: 2; height: inherit; opacity: .25; position: absolute; margin-left: 0px; width: 0px"></div>
        	<div id="playhead" style = "margin-left:400px;width:1px; background-color: #66FF99; height:inherit; position: absolute;z-index: 1;"></div>
            <img src="media/Oddity_1660.png" class="waveform_image" id="waveform_editor_image" style="left: 400px; position: relative; width: 1660px;"/>
        </div>
        <br /><br />
        <div id="test"><p></p></div>
        <div id="time"></div>
        <audio id="example_audio" src="media/Oddity.ogg" preload="auto">
            Your browser does not support the <code>audio</code> element.
        </audio>
        <div id="debug"></div>
        
        <input type="button" value="Play" id="play_button" />
        <input type="button" value="Pause" id="pause_button" />
    </body>
</html>